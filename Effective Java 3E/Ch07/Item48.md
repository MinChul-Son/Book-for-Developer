아이템 48. 스트림 병렬화는 주의해서 적용하라

자바 8 이후부터는 `parallel` 메소드로 파이프 라인을 병렬 실행할 수 있는 스트림을 지원한다.

병렬 스트림은 스트림을 재귀적으로 분할해 병렬화시키고, 병렬화된 각 작업을 쓰레드에게 할당하고 최종적으로 하나로 합친다.

병렬 스트림이 항상 순차 스트림보다 빠른 것이 아니라는 것에 주의해야한다.

데이터 소스가 `Stream.iterate`이거나 중간 연산으로 `limit`를 쓰면 파이프라인 병렬화로는 성능 개선을 할 수 없다.

스트림의 소스가 `ArrayList`, `HashMap`, `HashSet`, `ConcurrentHashMap`의 인스턴스이거나 배열, `int`범위, `long`범위일 때 병렬화의 효과가 가장 좋다.

그 이유는 앞서 이야기한 병렬화를 위해 각 쓰레드에게 작업을 할당할 때 데이터를 원하는 크기로 정확, 신속하게 나눌 수 있기 때문이다.

또한, 이들은 모두 **참조 지역성**이 뛰어나다.

---

<br>

스트림 파이프라인의 종단 연산의 동작 방식 또한 병렬 수행 성능에 영향을 미친다.

만약 종단 연산이 순차적인 연산이라면 병렬 수행의 효과는 제한된다.

병렬화에 가장 적합한 종단 연산은 `reduction`이다.

파이프라인에서 만들어진 모든 원소를 하나로 합치는 작업을 가르킨다.(`reduce`, `min`, `max`, `count`등등)

`anyMatch`, `allMatch`처럼 조건에 맞으면 바로 반환되는 메서드 또한 병렬화에 적합하다.

반대로, 컬렉션을 합치는 부담이 큰 `collect`는 병렬화에 적합하지 않다.

만약, 병렬화의 이점을 누리고 싶다면 `spliterator` 메서드를 재정의하고 결과 스트림의 성능 테스트를 강도 높게 진행해야한다.

#### 스트림을 잘못 병렬화하면 성능이 나빠질 뿐 아니라 결과 자체가 잘못될 수 있다.

스트림 병렬화는 오직 성능 최적화의 수단이므로 성능 테스트를 통해 병렬화의 가치가 있는지를 반드시 확인하자.

